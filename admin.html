<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Gmail Check</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .login-box {
            max-width: 400px;
            margin: 100px auto;
            padding: 40px;
            text-align: center;
        }

        .dashboard {
            display: none;
        }

        .log-container {
            background: var(--input-bg);
            border-radius: 12px;
            padding: 0;
            border: 1px solid var(--border-color);
            margin-top: 20px;
            overflow: hidden;
        }

        .log-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .log-source {
            background: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .log-data {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .stats-badge {
            background: var(--success-color);
            color: white;
            padding: 10px 20px;
            border-radius: 999px;
            font-weight: bold;
            margin-bottom: 20px;
            display: inline-block;
        }
    </style>
</head>

<body>
    <header>
        <a href="index.html" class="brand">
            <i class="fab fa-google"></i> Gmail Check Admin
        </a>
    </header>

    <main style="max-width: 1200px; margin: 0 auto; padding: 20px;">
        <!-- Login Section -->
        <div id="loginSection" class="card login-box">
            <h1 style="margin-bottom: 20px;">üîê Admin Access</h1>
            <p style="margin-bottom: 20px; color: var(--text-secondary);">Nh·∫≠p m√£ 2FA ƒë·ªÉ ti·∫øp t·ª•c</p>
            <input type="password" id="adminPassword" class="lang-select" placeholder="M√£ 2FA (6 s·ªë)"
                style="width: 100%; height: 50px; text-align: center; border: 2px solid var(--border-color); margin-bottom: 20px; font-size: 20px; letter-spacing: 5px;">
            <button onclick="login()" class="btn" style="width: 100%;">X√°c nh·∫≠n & ƒêƒÉng nh·∫≠p</button>
        </div>

        <!-- Dashboard Section: Only shown after login -->
        <div id="dashboardSection" class="dashboard">
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px;">

                <!-- Qu·∫£n l√Ω Banner -->
                <div class="card">
                    <h2
                        style="margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">
                        <i class="fas fa-ad"></i> C·∫•u h√¨nh Banner (Qu·∫£ng c√°o)
                    </h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="input-group">
                            <h4 style="color:var(--primary-color)">Banner B√™n Tr√°i</h4>
                            <label style="font-size:12px; opacity:0.7">URL ·∫¢nh (160x600)</label>
                            <input type="text" id="leftImg" class="lang-select" style="width:100%; margin-bottom:10px;"
                                placeholder="https://...">
                            <label style="font-size:12px; opacity:0.7">Link khi nh·∫•n v√†o</label>
                            <input type="text" id="leftLink" class="lang-select" style="width:100%;"
                                placeholder="https://...">
                        </div>
                        <div class="input-group">
                            <h4 style="color:var(--primary-color)">Banner B√™n Ph·∫£i</h4>
                            <label style="font-size:12px; opacity:0.7">URL ·∫¢nh (160x600)</label>
                            <input type="text" id="rightImg" class="lang-select" style="width:100%; margin-bottom:10px;"
                                placeholder="https://...">
                            <label style="font-size:12px; opacity:0.7">Link khi nh·∫•n v√†o</label>
                            <input type="text" id="rightLink" class="lang-select" style="width:100%;"
                                placeholder="https://...">
                        </div>
                    </div>
                    <button onclick="saveSettings()" class="btn" style="margin-top: 25px; width: 100%; height: 50px;">
                        <i class="fas fa-save"></i> C·∫≠p nh·∫≠t Banner l√™n Trang ch·ªß
                    </button>
                </div>

                <!-- Th·ªëng k√™ & ƒêi·ªÅu khi·ªÉn -->
                <div class="card" style="display: flex; flex-direction: column; justify-content: space-between;">
                    <div>
                        <h2 style="margin-bottom: 20px;"><i class="fas fa-chart-line"></i> Th·ªëng k√™</h2>
                        <div class="stats-badge" id="visitorStats"
                            style="width: 100%; text-align: center; margin-bottom: 15px;">
                            Kh√°ch h√¥m nay: 0
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button onclick="fetchLogs()" class="btn" style="width: 100%; background: #444;">
                            <i class="fas fa-sync"></i> Refresh Log (L√†m m·ªõi)
                        </button>
                        <button onclick="clearLogs()" class="btn btn-danger"
                            style="width: 100%; display: flex !important;">
                            <i class="fas fa-trash-alt"></i> X√ìA S·∫†CH LOG & TH·ªêNG K√ä
                        </button>
                    </div>
                </div>
            </div>

            <h2 style="margin-bottom: 15px;"><i class="fas fa-list-alt"></i> Nh·∫≠t k√Ω ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y</h2>
            <div id="logList" class="log-container" style="max-height: 800px; overflow-y: auto;">
                <div style="padding: 40px; text-align: center; color: var(--text-secondary);">ƒêang t·∫£i nh·∫≠t k√Ω...</div>
            </div>
        </div>
    </main>

    <script>
        let adminPass = '';

        async function login() {
            const pass = document.getElementById('adminPassword').value;
            if (!pass) return alert("Vui l√≤ng nh·∫≠p m√£ 2FA");

            try {
                const res = await fetch('/api/system', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'admin_get_logs', password: pass })
                });

                const data = await res.json();

                if (res.ok) {
                    adminPass = pass;
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('dashboardSection').style.display = 'block';
                    renderLogs(data.logs, data.visitorCount);
                    fetchSettings();
                } else {
                    alert("L·ªñI: " + (data.message || "M√£ 2FA kh√¥ng ch√≠nh x√°c"));
                }
            } catch (e) {
                alert("L·ªói k·∫øt n·ªëi API. H√£y ƒë·∫£m b·∫£o b·∫°n ƒë√£ Push code m·ªõi nh·∫•t l√™n Vercel.");
            }
        }

        async function fetchSettings() {
            try {
                const res = await fetch('/api/system', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'get_settings' })
                });
                if (res.ok) {
                    const s = await res.json();
                    document.getElementById('leftImg').value = s.banner_left_img || '';
                    document.getElementById('leftLink').value = s.banner_left_link || '';
                    document.getElementById('rightImg').value = s.banner_right_img || '';
                    document.getElementById('rightLink').value = s.banner_right_link || '';
                }
            } catch (e) { }
        }

        async function saveSettings() {
            const settings = {
                banner_left_img: document.getElementById('leftImg').value,
                banner_left_link: document.getElementById('leftLink').value,
                banner_right_img: document.getElementById('rightImg').value,
                banner_right_link: document.getElementById('rightLink').value
            };

            const res = await fetch('/api/system', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'admin_update_settings', password: adminPass, data: { settings } })
            });

            if (res.ok) {
                alert("ƒê√£ c·∫≠p nh·∫≠t Banner th√†nh c√¥ng!");
            } else {
                const data = await res.json();
                alert("L·ªói: " + (data.message || "Kh√¥ng th·ªÉ l∆∞u c√†i ƒë·∫∑t."));
            }
        }

        async function fetchLogs() {
            const list = document.getElementById('logList');
            list.style.opacity = '0.5';

            const res = await fetch('/api/system', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'admin_get_logs', password: adminPass })
            });

            list.style.opacity = '1';
            if (res.ok) {
                const data = await res.json();
                renderLogs(data.logs, data.visitorCount);
            }
        }

        async function clearLogs() {
            if (!confirm("C·∫¢NH B√ÅO: To√†n b·ªô nh·∫≠t k√Ω v√† th·ªëng k√™ truy c·∫≠p s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn. B·∫°n c√≥ ch·∫Øc ch·∫Øn kh√¥ng?")) return;

            const res = await fetch('/api/system', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'admin_clear_logs', password: adminPass })
            });

            if (res.ok) {
                alert("ƒê√£ x√≥a s·∫°ch Log!");
                renderLogs([], 0);
            } else {
                alert("X·∫£y ra l·ªói khi x√≥a Log.");
            }
        }

        function renderLogs(logs, visitorCount) {
            document.getElementById('visitorStats').textContent = `Kh√°ch h√¥m nay: ${visitorCount}`;
            const list = document.getElementById('logList');
            if (!logs || logs.length === 0) {
                list.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-secondary);">Ch∆∞a c√≥ nh·∫≠t k√Ω ho·∫°t ƒë·ªông n√†o.</div>';
                return;
            }

            list.innerHTML = logs.map(log => `
                <div class="log-item">
                    <div class="log-header">
                        <span><i class="fas fa-clock"></i> ${log.time}</span>
                        <span><i class="fas fa-network-wired"></i> IP: ${log.ip}</span>
                        <span class="log-source">${log.source}</span>
                    </div>
                    <div class="log-data">${escapeHtml(log.data)}</div>
                </div>
            `).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>

</html>